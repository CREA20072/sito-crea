<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin â€” CREA 20072</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --honey: #E3A500; --honey-dark: #C28D00; --black: #1a1a1a;
    --gray: #f4f4f4; --gray-mid: #e0e0e0; --text: #333; --text-light: #777;
    --danger: #e74c3c; --success: #27ae60; --radius: 14px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Montserrat', sans-serif; background: #f0f0f0; color: var(--text); min-height: 100vh; }

  /* â”€â”€ LOGIN â”€â”€ */
  #login-screen { min-height:100vh; display:flex; align-items:center; justify-content:center; background:var(--black); }
  .login-box { background:white; border-radius:24px; padding:3rem; width:100%; max-width:420px; text-align:center; }
  .login-box .bee { font-size:3.5rem; margin-bottom:1rem; }
  .login-box h1 { font-size:1.5rem; font-weight:800; margin-bottom:.25rem; text-transform:uppercase; }
  .login-box p { color:var(--text-light); font-size:.85rem; margin-bottom:2rem; }
  .login-box label { display:block; text-align:left; font-size:.7rem; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:var(--text-light); margin-bottom:.5rem; }
  .login-box input { width:100%; padding:.9rem 1rem; border:2px solid var(--gray-mid); border-radius:10px; font-family:'Montserrat',sans-serif; font-size:.9rem; margin-bottom:1.25rem; transition:border-color .2s; }
  .login-box input:focus { outline:none; border-color:var(--honey); }
  .login-box .hint { font-size:.72rem; color:var(--text-light); text-align:left; background:#fffbe6; border:1px solid #ffe082; border-radius:8px; padding:.75rem 1rem; margin-bottom:1.5rem; line-height:1.7; }
  .login-box .hint a { color:var(--honey-dark); font-weight:700; }

  /* â”€â”€ LAYOUT â”€â”€ */
  #app { display:none; }
  .topbar { background:var(--black); color:white; padding:1rem 2rem; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; }
  .topbar-left { display:flex; align-items:center; gap:.75rem; }
  .topbar-left .bee { font-size:1.6rem; }
  .topbar-left h1 { font-size:1rem; font-weight:800; text-transform:uppercase; letter-spacing:.1em; }
  .topbar-right { display:flex; align-items:center; gap:1rem; }
  .save-btn { background:var(--honey); color:white; border:none; border-radius:999px; padding:.65rem 1.75rem; font-family:'Montserrat',sans-serif; font-weight:700; font-size:.8rem; text-transform:uppercase; letter-spacing:.08em; cursor:pointer; transition:background .2s,transform .2s; }
  .save-btn:hover { background:var(--honey-dark); transform:translateY(-2px); }
  .save-btn:disabled { opacity:.5; cursor:not-allowed; transform:none; }
  .logout-btn { background:transparent; color:rgba(255,255,255,.5); border:1px solid rgba(255,255,255,.2); border-radius:999px; padding:.5rem 1rem; font-family:'Montserrat',sans-serif; font-size:.72rem; font-weight:600; text-transform:uppercase; letter-spacing:.08em; cursor:pointer; transition:all .2s; }
  .logout-btn:hover { color:white; border-color:white; }
  .main-layout { display:flex; max-width:1200px; margin:0 auto; padding:2rem; gap:2rem; }

  /* â”€â”€ SIDEBAR â”€â”€ */
  .sidebar { width:220px; flex-shrink:0; position:sticky; top:80px; height:fit-content; }
  .sidebar nav { background:white; border-radius:var(--radius); overflow:hidden; box-shadow:0 2px 12px rgba(0,0,0,.06); }
  .nav-group-label { font-size:.6rem; font-weight:800; text-transform:uppercase; letter-spacing:.15em; color:var(--text-light); padding:.8rem 1.25rem .3rem; background:white; }
  .nav-divider { height:1px; background:var(--gray-mid); margin:.3rem 0; }
  .nav-item { display:flex; align-items:center; gap:.75rem; padding:.85rem 1.25rem; font-size:.78rem; font-weight:700; text-transform:uppercase; letter-spacing:.08em; color:var(--text-light); cursor:pointer; border-left:3px solid transparent; transition:all .2s; border-bottom:1px solid var(--gray); }
  .nav-item:last-child { border-bottom:none; }
  .nav-item:hover { color:var(--honey); background:#fffbe6; }
  .nav-item.active { color:var(--honey); background:#fffbe6; border-left-color:var(--honey); }
  .nav-item .icon { font-size:1.1rem; }

  /* â”€â”€ CONTENT / PANELS â”€â”€ */
  .content { flex:1; min-width:0; }
  .panel { background:white; border-radius:var(--radius); box-shadow:0 2px 12px rgba(0,0,0,.06); overflow:hidden; display:none; margin-bottom:1.5rem; }
  .panel.active { display:block; }
  .panel-header { padding:1.5rem 2rem; border-bottom:2px solid var(--gray); display:flex; align-items:center; gap:1rem; }
  .panel-header .icon { font-size:1.5rem; }
  .panel-header h2 { font-size:1rem; font-weight:800; text-transform:uppercase; letter-spacing:.05em; }
  .panel-header p { font-size:.78rem; color:var(--text-light); margin-top:.15rem; }
  .panel-body { padding:2rem; }

  /* â”€â”€ FORM â”€â”€ */
  .field { margin-bottom:1.25rem; }
  .field label { display:block; font-size:.7rem; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:var(--text-light); margin-bottom:.45rem; }
  .field input, .field textarea, .field select { width:100%; padding:.85rem 1rem; border:2px solid var(--gray-mid); border-radius:10px; font-family:'Montserrat',sans-serif; font-size:.9rem; color:var(--text); transition:border-color .2s; background:white; }
  .field input:focus, .field textarea:focus, .field select:focus { outline:none; border-color:var(--honey); }
  .field textarea { resize:vertical; min-height:80px; line-height:1.6; }
  .field-row  { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
  .field-row3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:1rem; }

  /* â”€â”€ RICH TEXT EDITOR â”€â”€ */
  .rich-editor { border:2px solid var(--gray-mid); border-radius:10px; overflow:hidden; transition:border-color .2s; }
  .rich-editor:focus-within { border-color:var(--honey); }
  .rich-toolbar { background:var(--gray); padding:.4rem .75rem; display:flex; gap:.3rem; align-items:center; flex-wrap:wrap; border-bottom:1px solid var(--gray-mid); }
  .tb-btn { background:white; border:1px solid var(--gray-mid); border-radius:6px; padding:.2rem .55rem; cursor:pointer; font-size:.8rem; font-family:'Montserrat',sans-serif; transition:all .2s; min-width:28px; text-align:center; line-height:1.4; }
  .tb-btn:hover { background:var(--honey); color:white !important; border-color:var(--honey); }
  .tb-sep { width:1px; height:16px; background:var(--gray-mid); margin:0 .1rem; flex-shrink:0; }
  .tb-dot { width:18px; height:18px; border-radius:50%; border:2px solid rgba(0,0,0,.15); cursor:pointer; display:inline-block; transition:transform .2s,box-shadow .2s; flex-shrink:0; }
  .tb-dot:hover { transform:scale(1.35); box-shadow:0 0 0 2px white, 0 0 0 3px currentColor; }
  .rich-content { padding:.85rem 1rem; min-height:90px; font-family:'Montserrat',sans-serif; font-size:.9rem; color:var(--text); outline:none; line-height:1.7; }
  .rich-content:empty:before { content:attr(data-placeholder); color:#bbb; pointer-events:none; display:block; }

  /* â”€â”€ DIMENSION HINT â”€â”€ */
  .dim-hint { display:inline-flex; align-items:center; gap:.5rem; background:#fffbe6; border:1px solid #ffe082; border-radius:8px; padding:.45rem .9rem; font-size:.7rem; font-weight:700; color:#92670a; margin-bottom:.75rem; line-height:1.5; }
  .dim-hint .ratio-icon { font-size:1rem; }

  /* â”€â”€ SECTION BLOCKS inside panel â”€â”€ */
  .section-block { margin-bottom:1.75rem; padding-bottom:1.75rem; border-bottom:1px solid var(--gray); }
  .section-block:last-child { border-bottom:none; margin-bottom:0; padding-bottom:0; }
  .section-label { font-size:.72rem; font-weight:800; text-transform:uppercase; letter-spacing:.1em; color:var(--text-light); margin-bottom:1rem; display:flex; align-items:center; gap:.4rem; }

  /* â”€â”€ ARCHIVIO â”€â”€ */
  .archive-list { display:flex; flex-direction:column; gap:1rem; }
  .archive-item { border:2px solid var(--gray-mid); border-radius:12px; overflow:hidden; transition:border-color .2s; }
  .archive-item.editing { border-color:var(--honey); }
  .archive-item-header { padding:1rem 1.25rem; display:flex; align-items:center; justify-content:space-between; cursor:pointer; background:var(--gray); transition:background .2s; }
  .archive-item-header:hover { background:#fffbe6; }
  .archive-item-title { display:flex; align-items:center; gap:.75rem; font-weight:700; font-size:.85rem; flex:1; min-width:0; overflow:hidden; }
  .tag-badge { font-size:.65rem; padding:.2rem .6rem; border-radius:999px; font-weight:700; text-transform:uppercase; letter-spacing:.05em; white-space:nowrap; flex-shrink:0; }
  .tag-famiglie  { background:#dbeafe; color:#1e40af; }
  .tag-tradizioni{ background:#fed7aa; color:#9a3412; }
  .tag-spettacoli{ background:#e9d5ff; color:#6b21a8; }
  .archive-item-actions { display:flex; gap:.5rem; flex-shrink:0; }
  .btn-sm { padding:.4rem .9rem; border-radius:8px; font-family:'Montserrat',sans-serif; font-size:.7rem; font-weight:700; text-transform:uppercase; cursor:pointer; border:none; transition:all .2s; white-space:nowrap; }
  .btn-danger  { background:#fee2e2; color:var(--danger); }
  .btn-danger:hover  { background:var(--danger); color:white; }
  .btn-primary { background:#fef3c7; color:var(--honey-dark); }
  .btn-primary:hover { background:var(--honey); color:white; }
  .archive-item-body { padding:1.5rem; display:none; }
  .archive-item.editing .archive-item-body { display:block; }
  .add-event-btn { width:100%; padding:1rem; border:2px dashed var(--gray-mid); border-radius:12px; background:transparent; font-family:'Montserrat',sans-serif; font-size:.8rem; font-weight:700; text-transform:uppercase; letter-spacing:.08em; color:var(--text-light); cursor:pointer; transition:all .2s; }
  .add-event-btn:hover { border-color:var(--honey); color:var(--honey); background:#fffbe6; }

  /* â”€â”€ DECALOGO â”€â”€ */
  .decalogo-list { display:flex; flex-direction:column; gap:.6rem; }
  .decalogo-item { border:1px solid var(--gray-mid); border-radius:10px; overflow:hidden; transition:border-color .2s; }
  .decalogo-item.open { border-color:var(--honey); }
  .decalogo-item-header { padding:.8rem 1rem; background:var(--gray); display:flex; align-items:center; gap:.75rem; cursor:pointer; transition:background .2s; }
  .decalogo-item.open .decalogo-item-header { background:#fffbe6; }
  .decalogo-item-header:hover { background:#fffbe6; }
  .dec-num { font-size:.65rem; font-weight:800; color:var(--honey); background:white; border:1px solid #ffe082; border-radius:6px; padding:.15rem .5rem; flex-shrink:0; }
  .dec-arrow { margin-left:auto; font-size:.75rem; color:var(--text-light); transition:transform .2s; }
  .decalogo-item.open .dec-arrow { transform:rotate(90deg); }
  .decalogo-item-body { padding:1.25rem; display:none; }
  .decalogo-item.open .decalogo-item-body { display:block; }

  /* â”€â”€ PILLARS â”€â”€ */
  .pillar-list { display:flex; flex-direction:column; gap:.75rem; }
  .pillar-item { border:1px solid var(--gray-mid); border-radius:10px; padding:1.25rem; background:var(--gray); }
  .pillar-num { font-size:.65rem; font-weight:800; color:var(--honey); text-transform:uppercase; letter-spacing:.1em; margin-bottom:.75rem; }

  /* â”€â”€ UPLOAD â”€â”€ */
  .upload-zone { border:2px dashed var(--gray-mid); border-radius:10px; padding:1.5rem; text-align:center; cursor:pointer; transition:all .2s; background:white; position:relative; }
  .upload-zone:hover,.upload-zone.drag-over { border-color:var(--honey); background:#fffbe6; }
  .upload-zone input[type=file] { position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%; }
  .upload-zone .upload-icon { font-size:2rem; margin-bottom:.5rem; }
  .upload-zone .upload-text { font-size:.78rem; font-weight:700; color:var(--text-light); text-transform:uppercase; letter-spacing:.06em; }
  .upload-zone .upload-sub  { font-size:.7rem; color:var(--text-light); margin-top:.25rem; }
  .upload-progress { margin-top:.75rem; display:none; }
  .upload-progress-bar  { height:4px; background:var(--gray-mid); border-radius:999px; overflow:hidden; }
  .upload-progress-fill { height:100%; background:var(--honey); border-radius:999px; transition:width .3s; }
  .uploaded-files { display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.75rem; }
  .uploaded-chip { background:#f0fdf4; border:1px solid #bbf7d0; color:#166534; border-radius:999px; padding:.3rem .8rem; font-size:.72rem; font-weight:700; display:flex; align-items:center; gap:.4rem; cursor:pointer; transition:all .2s; }
  .uploaded-chip:hover { background:#dcfce7; }

  /* â”€â”€ STATUS BAR â”€â”€ */
  .status-bar { background:white; border-radius:var(--radius); padding:1rem 1.5rem; margin-bottom:1.5rem; display:flex; align-items:center; justify-content:space-between; box-shadow:0 2px 12px rgba(0,0,0,.06); }
  .status-bar .repo-info { font-size:.75rem; color:var(--text-light); }
  .status-bar .repo-info strong { color:var(--text); }
  .status-dot { width:8px; height:8px; border-radius:50%; background:var(--success); display:inline-block; margin-right:.5rem; }

  /* â”€â”€ TOAST â”€â”€ */
  #toast { position:fixed; bottom:2rem; right:2rem; background:var(--black); color:white; padding:1rem 1.5rem; border-radius:12px; font-size:.85rem; font-weight:600; box-shadow:0 8px 30px rgba(0,0,0,.3); z-index:9999; transform:translateY(100px); opacity:0; transition:all .35s cubic-bezier(.34,1.56,.64,1); max-width:340px; }
  #toast.show { transform:translateY(0); opacity:1; }
  #toast.success { border-left:4px solid var(--success); }
  #toast.error   { border-left:4px solid var(--danger); }
  #toast.loading { border-left:4px solid var(--honey); }

  /* â”€â”€ RESPONSIVE â”€â”€ */
  @media (max-width:768px) {
    .main-layout { flex-direction:column; padding:1rem; }
    .sidebar { width:100%; position:static; }
    .sidebar nav { display:flex; overflow-x:auto; border-radius:var(--radius); }
    .nav-group-label,.nav-divider { display:none; }
    .nav-item { white-space:nowrap; border-left:none; border-bottom:3px solid transparent; flex-shrink:0; }
    .nav-item.active { border-left:none; border-bottom-color:var(--honey); }
    .field-row,.field-row3 { grid-template-columns:1fr; }
    .topbar-left h1 { display:none; }
    .status-bar { flex-direction:column; gap:.5rem; align-items:flex-start; }
  }
</style>
</head>
<body>

<!-- â•â•â• LOGIN â•â•â• -->
<div id="login-screen">
  <div class="login-box">
    <div class="bee">ğŸ</div>
    <h1>CREA 20072</h1>
    <p>Pannello di gestione contenuti</p>
    <label for="inp-owner">Username GitHub</label>
    <input id="inp-owner" type="text" placeholder="es. CREA20072" autocomplete="off">
    <label for="inp-repo">Nome repository GitHub</label>
    <input id="inp-repo" type="text" placeholder="es. sito-crea" autocomplete="off">
    <label for="inp-token">Personal Access Token</label>
    <input id="inp-token" type="password" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" autocomplete="off">
    <div class="hint">
      ğŸ“Œ <strong>Come creare il token (una volta sola):</strong><br>
      1. GitHub â†’ foto profilo â†’ <em>Settings</em><br>
      2. In fondo â†’ <em>Developer settings â†’ Personal access tokens â†’ Tokens (classic)</em><br>
      3. <em>Generate new token (classic)</em> â†’ spunta <strong>repo</strong> â†’ <em>Generate token</em><br>
      4. Copia e incolla qui sopra.<br><br>
      <a href="https://github.com/settings/tokens/new?scopes=repo&description=CREA20072+Admin" target="_blank">â†’ Clicca qui per crearlo direttamente</a>
    </div>
    <button class="save-btn" style="width:100%" onclick="doLogin()">ğŸ”‘ Accedi</button>
  </div>
</div>

<!-- â•â•â• APP â•â•â• -->
<div id="app">
  <div class="topbar">
    <div class="topbar-left">
      <span class="bee">ğŸ</span>
      <h1>CREA 20072 â€” Admin</h1>
    </div>
    <div class="topbar-right">
      <button class="save-btn" id="save-btn" onclick="saveAll()">ğŸ’¾ Salva tutto</button>
      <button class="logout-btn" onclick="doLogout()">Esci</button>
    </div>
  </div>

  <div class="main-layout">

    <!-- â”€â”€ SIDEBAR â”€â”€ -->
    <div class="sidebar">
      <nav>
        <div class="nav-group-label">EVENTI</div>
        <div class="nav-item active" onclick="showSection('evento')"   id="nav-evento">  <span class="icon">â­</span> Prossimo Evento</div>
        <div class="nav-item"        onclick="showSection('archivio')" id="nav-archivio"><span class="icon">ğŸ“</span> Archivio</div>
        <div class="nav-item"        onclick="showSection('upload')"   id="nav-upload">  <span class="icon">ğŸ–¼ï¸</span> Carica Foto</div>
        <div class="nav-divider"></div>
        <div class="nav-group-label">SITO</div>
        <div class="nav-item" onclick="showSection('home')"     id="nav-home">    <span class="icon">ğŸ </span> Homepage</div>
        <div class="nav-item" onclick="showSection('chisiamo')" id="nav-chisiamo"><span class="icon">ğŸ‘¥</span> Chi Siamo</div>
        <div class="nav-item" onclick="showSection('decalogo')" id="nav-decalogo"><span class="icon">ğŸ“œ</span> Decalogo</div>
        <div class="nav-divider"></div>
        <div class="nav-group-label">ALTRO</div>
        <div class="nav-item" onclick="showSection('footer')" id="nav-footer"><span class="icon">ğŸ“¬</span> Contatti</div>
      </nav>
    </div>

    <!-- â”€â”€ CONTENT â”€â”€ -->
    <div class="content">
      <div class="status-bar">
        <span class="repo-info"><span class="status-dot"></span>Connesso a <strong id="repo-label">â€”</strong></span>
        <span style="font-size:.72rem;color:var(--text-light)">Le modifiche vengono salvate su GitHub</span>
      </div>

      <!-- â­ PROSSIMO EVENTO -->
      <div class="panel active" id="panel-evento">
        <div class="panel-header"><span class="icon">â­</span>
          <div><h2>Prossimo Evento in Evidenza</h2><p>Appare nella sezione principale del sito</p></div>
        </div>
        <div class="panel-body">
          <div class="section-block">
            <div class="section-label">ğŸ“‹ Informazioni</div>
            <div class="field-row">
              <div class="field"><label>Titolo evento *</label><input id="ev-title" type="text" placeholder="es. Magic Show"></div>
              <div class="field"><label>Sottotitolo / Artista</label><input id="ev-sub" type="text" placeholder="es. Mago Daniel"></div>
            </div>
            <div class="field-row3">
              <div class="field"><label>Giorno (2 cifre)</label><input id="ev-day" type="text" placeholder="01" maxlength="2"></div>
              <div class="field"><label>Mese (3 lettere)</label><input id="ev-month" type="text" placeholder="MAR" maxlength="3"></div>
              <div class="field"><label>Data completa per testo</label><input id="ev-fulldate" type="text" placeholder="Domenica 1 Marzo 2026 â€“ Ore 16:00"></div>
            </div>
            <div class="field-row">
              <div class="field"><label>Luogo</label><input id="ev-place" type="text" placeholder="Auditorium Sant'Alessandro"></div>
              <div class="field"><label>Contributo / Prezzo</label><input id="ev-prices" type="text" placeholder="10â‚¬ â€“ Spettacolo + Merenda"></div>
            </div>
            <div class="field"><label>Link WhatsApp prenotazioni</label><input id="ev-wa" type="text" placeholder="https://wa.me/393402231735"></div>
          </div>
          <div class="section-block">
            <div class="section-label">ğŸ“ Descrizione</div>
            <div class="field">
              <label>Testo descrittivo â€” supporta <b>grassetto</b>, <i>corsivo</i>, colori</label>
              <div id="rich-ev-desc"></div>
            </div>
          </div>
          <div class="section-block">
            <div class="section-label">ğŸ–¼ï¸ Locandina / Immagine copertina</div>
            <div class="dim-hint"><span class="ratio-icon">ğŸ“</span>
              Dimensioni ideali: <strong>600 Ã— 900 px</strong> â€” verticale 2:3 (tipo flyer Instagram o A4 portrait) â€” evita il ritaglio automatico
            </div>
            <div class="field"><label>Nome file immagine (giÃ  caricato su GitHub)</label><input id="ev-img" type="text" placeholder="mago.png"></div>
          </div>
        </div>
      </div>

      <!-- ğŸ“ ARCHIVIO -->
      <div class="panel" id="panel-archivio">
        <div class="panel-header"><span class="icon">ğŸ“</span>
          <div><h2>Archivio Eventi Passati</h2><p>Ordinati automaticamente dal piÃ¹ recente</p></div>
        </div>
        <div class="panel-body">
          <div id="archive-list" class="archive-list"></div>
          <button class="add-event-btn" onclick="addArchiveItem()" style="margin-top:1rem">+ Aggiungi nuovo evento passato</button>
        </div>
      </div>

      <!-- ğŸ–¼ï¸ CARICA FOTO -->
      <div class="panel" id="panel-upload">
        <div class="panel-header"><span class="icon">ğŸ–¼ï¸</span>
          <div><h2>Carica Immagini</h2><p>Trascina i file â€” vengono caricati direttamente su GitHub</p></div>
        </div>
        <div class="panel-body">
          <div class="section-block">
            <div class="section-label">ğŸ¯ A quale evento appartengono le foto?</div>
            <div class="field-row">
              <div class="field">
                <label>Evento di destinazione</label>
                <select id="upload-event-selector">
                  <option value="">â€” Seleziona evento â€”</option>
                  <option value="featured">â­ Prossimo Evento (copertina)</option>
                </select>
              </div>
              <div class="field">
                <label>Tipo di immagine</label>
                <select id="upload-image-type">
                  <option value="gallery">ğŸ“¸ Galleria foto</option>
                  <option value="cover">ğŸ–¼ï¸ Immagine copertina</option>
                </select>
              </div>
            </div>
            <div id="upload-destination-preview" style="font-size:.72rem;color:var(--honey-dark);font-weight:700;background:#fffbe6;border:1px solid #ffe082;border-radius:8px;padding:.5rem .9rem;display:none;"></div>
          </div>
          <div class="section-block">
            <div class="section-label">ğŸ“¤ Carica file</div>
            <div class="upload-zone" id="upload-zone" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
              <input type="file" id="file-input" multiple accept="image/*" onchange="handleFileSelect(event)">
              <div class="upload-icon">ğŸ“¤</div>
              <div class="upload-text">Trascina le foto qui oppure clicca per sceglierle</div>
              <div class="upload-sub">PNG, JPG, JPEG, WebP â€” max 5 MB per file</div>
            </div>
            <div class="upload-progress" id="upload-progress">
              <div style="font-size:.75rem;font-weight:700;color:var(--text-light);margin-bottom:.4rem" id="upload-status-text">Caricamento...</div>
              <div class="upload-progress-bar"><div class="upload-progress-fill" id="upload-progress-fill" style="width:0%"></div></div>
            </div>
            <div id="uploaded-files-list" class="uploaded-files" style="margin-top:1rem"></div>
          </div>
        </div>
      </div>

      <!-- ğŸ  HOMEPAGE / HERO -->
      <div class="panel" id="panel-home">
        <div class="panel-header"><span class="icon">ğŸ </span>
          <div><h2>Homepage â€” Copertina</h2><p>La prima sezione che vede chi apre il sito</p></div>
        </div>
        <div class="panel-body">
          <div class="field"><label>Titolo principale</label><input id="hero-title" type="text" placeholder="Non aspettiamo che succeda qualcosa. Lo organizziamo."></div>
          <div class="field">
            <label>Sottotitolo â€” supporta <b>grassetto</b>, <i>corsivo</i>, colori</label>
            <div id="rich-hero-subtitle"></div>
          </div>
          <div class="field-row">
            <div class="field"><label>Testo bottone CTA</label><input id="hero-cta" type="text" placeholder="Guarda cosa stiamo preparando ğŸ”¥"></div>
            <div class="field"><label>URL immagine sfondo</label><input id="hero-bg" type="text" placeholder="https://..."></div>
          </div>
        </div>
      </div>

      <!-- ğŸ‘¥ CHI SIAMO -->
      <div class="panel" id="panel-chisiamo">
        <div class="panel-header"><span class="icon">ğŸ‘¥</span>
          <div><h2>Chi Siamo</h2><p>Presentazione dell'associazione</p></div>
        </div>
        <div class="panel-body">
          <div class="section-block">
            <div class="section-label">ğŸ“– Testo principale</div>
            <div class="field"><label>Titolo sezione</label><input id="about-title" type="text" placeholder="PerchÃ© lo facciamo"></div>
            <div class="field">
              <label>Testo descrittivo â€” supporta <b>grassetto</b>, <i>corsivo</i>, colori</label>
              <div id="rich-about-text"></div>
            </div>
            <div class="field"><label>Frase finale (piccola, sotto il testo)</label><input id="about-tagline" type="text" placeholder="Un progetto indipendente, costruito con le nostre forze."></div>
          </div>
          <div class="section-block">
            <div class="section-label">ğŸ›ï¸ I tre pilastri (colonne sotto il testo)</div>
            <div class="pillar-list" id="pillars-list"></div>
          </div>
        </div>
      </div>

      <!-- ğŸ“œ DECALOGO -->
      <div class="panel" id="panel-decalogo">
        <div class="panel-header"><span class="icon">ğŸ“œ</span>
          <div><h2>Il Decalogo</h2><p>I 10 valori che guidano l'associazione</p></div>
        </div>
        <div class="panel-body">
          <div class="decalogo-list" id="decalogo-list"></div>
        </div>
      </div>

      <!-- ğŸ“¬ CONTATTI -->
      <div class="panel" id="panel-footer">
        <div class="panel-header"><span class="icon">ğŸ“¬</span>
          <div><h2>Contatti e Footer</h2><p>Email, social, frase finale</p></div>
        </div>
        <div class="panel-body">
          <div class="section-block">
            <div class="section-label">ğŸ“§ Contatti</div>
            <div class="field"><label>Email di contatto</label><input id="footer-email" type="email" placeholder="accrea20072@gmail.com"></div>
          </div>
          <div class="section-block">
            <div class="section-label">ğŸ”— Social</div>
            <div class="field-row">
              <div class="field"><label>URL Facebook</label><input id="social-fb" type="text" placeholder="https://www.facebook.com/..."></div>
              <div class="field"><label>URL Instagram</label><input id="social-ig" type="text" placeholder="https://www.instagram.com/crea20072/"></div>
            </div>
          </div>
          <div class="section-block">
            <div class="section-label">ğŸ’¬ Frase ispirazionale (fondo pagina)</div>
            <div class="field"><div id="rich-footer-quote"></div></div>
          </div>
          <div class="section-block">
            <div class="section-label">âš™ï¸ Impostazioni</div>
            <div class="field"><label>Formspree URL (per ricevere email dal form contatti)</label><input id="settings-formspree" type="text" placeholder="https://formspree.io/f/..."></div>
          </div>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /main-layout -->
</div><!-- /app -->

<div id="toast"></div>

<script>
let OWNER = '', REPO = '', TOKEN = '', SHA = '', DATA = null;

// â”€â”€â”€ RICH TEXT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const RICH_TOOLBAR = `
  <div class="rich-toolbar">
    <button type="button" class="tb-btn" onmousedown="execFmt(event,'bold')" title="Grassetto (Ctrl+B)"><b>B</b></button>
    <button type="button" class="tb-btn" onmousedown="execFmt(event,'italic')" title="Corsivo (Ctrl+I)"><i>I</i></button>
    <button type="button" class="tb-btn" onmousedown="execFmt(event,'underline')" title="Sottolineato"><u>U</u></button>
    <div class="tb-sep"></div>
    <span class="tb-dot" style="background:#E3A500" onmousedown="execColor(event,'#E3A500')" title="Giallo miele"></span>
    <span class="tb-dot" style="background:#e74c3c" onmousedown="execColor(event,'#e74c3c')" title="Rosso"></span>
    <span class="tb-dot" style="background:#27ae60" onmousedown="execColor(event,'#27ae60')" title="Verde"></span>
    <span class="tb-dot" style="background:#1F2933" onmousedown="execColor(event,'#1F2933')" title="Nero"></span>
    <span class="tb-dot" style="background:#6B7280" onmousedown="execColor(event,'#6B7280')" title="Grigio"></span>
    <div class="tb-sep"></div>
    <button type="button" class="tb-btn" onmousedown="execFmt(event,'removeFormat')" title="Rimuovi formattazione" style="font-size:.7rem;color:#999">âœ• fmt</button>
  </div>`;

function richEditorHTML(id, html, placeholder) {
  const ph = placeholder || '';
  return `<div class="rich-editor">${RICH_TOOLBAR}<div class="rich-content" id="${id}" contenteditable="true" data-placeholder="${ph}">${html || ''}</div></div>`;
}

function initStaticRichEditors() {
  // Container IDs â†’ [rich-content ID, placeholder]
  const editors = [
    ['rich-ev-desc',       'ev-desc',       'Descrizione dell\'evento per i visitatori...'],
    ['rich-hero-subtitle', 'hero-subtitle',  'Descrizione breve...'],
    ['rich-about-text',    'about-text',     'Racconta l\'associazione...'],
    ['rich-footer-quote',  'footer-quote',   'Ogni evento Ã¨ un passo in piÃ¹...'],
  ];
  editors.forEach(([containerId, contentId, ph]) => {
    const el = document.getElementById(containerId);
    if (el) el.innerHTML = richEditorHTML(contentId, '', ph);
  });
}

function execFmt(e, cmd) {
  e.preventDefault();
  document.execCommand(cmd, false, null);
}
function execColor(e, color) {
  e.preventDefault();
  document.execCommand('foreColor', false, color);
}
function getRich(id) {
  const el = document.getElementById(id);
  if (!el) return '';
  return el.classList.contains('rich-content') ? el.innerHTML : (el.value || '');
}
function setRich(id, html) {
  const el = document.getElementById(id);
  if (!el) return;
  if (el.classList.contains('rich-content')) el.innerHTML = html || '';
  else el.value = html || '';
}

// â”€â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function doLogin() {
  OWNER = document.getElementById('inp-owner').value.trim();
  REPO  = document.getElementById('inp-repo').value.trim();
  TOKEN = document.getElementById('inp-token').value.trim();
  if (!OWNER || !REPO || !TOKEN) { showToast('âš ï¸ Compila tutti i campi', 'error'); return; }
  showToast('Connessione in corso...', 'loading');
  try {
    const ok = await loadData();
    if (ok) {
      localStorage.setItem('crea_owner', OWNER);
      localStorage.setItem('crea_repo',  REPO);
      localStorage.setItem('crea_token', TOKEN);
      startApp();
    }
  } catch(e) { showToast('âŒ Errore: controlla username, repo e token.', 'error'); }
}

function doLogout() {
  ['crea_owner','crea_repo','crea_token'].forEach(k => localStorage.removeItem(k));
  location.reload();
}

function startApp() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  document.getElementById('repo-label').textContent = `${OWNER}/${REPO}`;
  populateForm();
  showToast('âœ… Connesso con successo!', 'success');
}

// â”€â”€â”€ GITHUB API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadData() {
  const res = await fetch(
    `https://api.github.com/repos/${OWNER}/${REPO}/contents/data/content.json`,
    { headers: { Authorization: `token ${TOKEN}`, Accept: 'application/vnd.github.v3+json' } }
  );
  if (!res.ok) { showToast('âŒ File non trovato. Controlla username e nome repo.', 'error'); return false; }
  const file = await res.json();
  SHA = file.sha;
  const bytes = Uint8Array.from(atob(file.content.replace(/\n/g,'')), c => c.charCodeAt(0));
  DATA = JSON.parse(new TextDecoder('utf-8').decode(bytes));
  return true;
}

async function saveAll() {
  const btn = document.getElementById('save-btn');
  btn.disabled = true;
  showToast('Salvataggio in corso...', 'loading');
  try {
    collectForm();
    const jsonString = JSON.stringify(DATA, null, 2);
    const bytes = new TextEncoder().encode(jsonString);
    const binString = Array.from(bytes, b => String.fromCodePoint(b)).join('');
    const content = btoa(binString);
    const res = await fetch(
      `https://api.github.com/repos/${OWNER}/${REPO}/contents/data/content.json`,
      {
        method: 'PUT',
        headers: { Authorization: `token ${TOKEN}`, Accept: 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: 'âœï¸ Admin: aggiornamento contenuti', content, sha: SHA })
      }
    );
    if (!res.ok) throw new Error((await res.json()).message);
    SHA = (await res.json()).content.sha;
    showToast('âœ… Salvato! Il sito si aggiorna tra pochi secondi.', 'success');
  } catch(e) { showToast('âŒ Errore nel salvataggio: ' + e.message, 'error'); }
  btn.disabled = false;
}

// â”€â”€â”€ POPULATE FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function populateForm() {
  const D = DATA, ev = D.featuredEvent || {};
  // Evento
  set('ev-title', ev.title); set('ev-sub', ev.sub); set('ev-day', ev.day);
  set('ev-month', ev.month); set('ev-fulldate', ev.fullDate); set('ev-place', ev.place);
  set('ev-prices', ev.prices); set('ev-wa', ev.wa); set('ev-img', ev.img);
  setRich('ev-desc', ev.desc);
  // Hero
  set('hero-title', D.hero?.title); set('hero-cta', D.hero?.cta); set('hero-bg', D.hero?.bg);
  setRich('hero-subtitle', D.hero?.subtitle);
  // Chi siamo
  set('about-title', D.about?.title); set('about-tagline', D.about?.tagline);
  setRich('about-text', D.about?.text);
  renderPillars(D.about?.pillars || []);
  // Decalogo
  renderDecalogo(D.decalogo?.items || []);
  // Footer
  set('footer-email', D.footer?.email);
  setRich('footer-quote', D.footer?.quote);
  const fb = (D.footer?.socials||[]).find(s => s.icon==='facebook');
  const ig = (D.footer?.socials||[]).find(s => s.icon==='instagram');
  set('social-fb', fb?.url); set('social-ig', ig?.url);
  set('settings-formspree', D.settings?.formspreeUrl);
  // Archivio
  renderArchiveList();
  // Upload selector
  populateUploadSelector();
}

function set(id, val) { const el = document.getElementById(id); if (el) el.value = val || ''; }

// â”€â”€â”€ COLLECT FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function collectForm() {
  const g = id => document.getElementById(id)?.value?.trim() || '';
  DATA.featuredEvent = {
    title: g('ev-title'), sub: g('ev-sub'), day: g('ev-day'),
    month: g('ev-month').toUpperCase(), fullDate: g('ev-fulldate'),
    place: g('ev-place'), prices: g('ev-prices'),
    desc: getRich('ev-desc'), wa: g('ev-wa'), img: g('ev-img')
  };
  DATA.hero = { title: g('hero-title'), subtitle: getRich('hero-subtitle'), cta: g('hero-cta'), bg: g('hero-bg') };
  DATA.about = { ...DATA.about, title: g('about-title'), text: getRich('about-text'), tagline: g('about-tagline'), pillars: collectPillars() };
  DATA.decalogo = { ...DATA.decalogo, items: collectDecalogo() };
  DATA.footer = { ...DATA.footer, email: g('footer-email'), quote: getRich('footer-quote'),
    socials: [{icon:'facebook',url:g('social-fb')},{icon:'instagram',url:g('social-ig')}].filter(s => s.url) };
  DATA.settings = { ...DATA.settings, formspreeUrl: g('settings-formspree') };
  collectArchive();
}

// â”€â”€â”€ PILLARS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderPillars(pillars) {
  const container = document.getElementById('pillars-list');
  container.innerHTML = '';
  for (let i = 0; i < 3; i++) {
    const p = pillars[i] || {};
    container.innerHTML += `
      <div class="pillar-item">
        <div class="pillar-num">Pilastro ${i+1}</div>
        <div class="field-row3">
          <div class="field"><label>Icona Lucide</label><input type="text" id="pillar-icon-${i}" value="${esc(p.icon||'')}" placeholder="es. users, heart, sparkles"></div>
          <div class="field"><label>Titolo</label><input type="text" id="pillar-t-${i}" value="${esc(p.t||'')}" placeholder="es. ComunitÃ "></div>
          <div class="field"><label>Descrizione</label><input type="text" id="pillar-d-${i}" value="${esc(p.d||'')}" placeholder="es. Creiamo occasioni..."></div>
        </div>
      </div>`;
  }
}

function collectPillars() {
  return [0,1,2].map(i => ({
    icon: document.getElementById(`pillar-icon-${i}`)?.value?.trim() || '',
    t:    document.getElementById(`pillar-t-${i}`)?.value?.trim() || '',
    d:    document.getElementById(`pillar-d-${i}`)?.value?.trim() || ''
  })).filter(p => p.t || p.icon);
}

// â”€â”€â”€ DECALOGO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderDecalogo(items) {
  const container = document.getElementById('decalogo-list');
  container.innerHTML = '';
  items.forEach((item, idx) => {
    const div = document.createElement('div');
    div.className = 'decalogo-item';
    div.id = `dec-${idx}`;
    div.innerHTML = `
      <div class="decalogo-item-header" onclick="toggleDec(${idx})">
        <span class="dec-num">${esc(item.n || String(idx+1).padStart(2,'0'))}</span>
        <span style="font-weight:700;font-size:.85rem;flex:1" id="dec-label-${idx}">${esc(item.t||'')}</span>
        <span class="dec-arrow">â–¸</span>
      </div>
      <div class="decalogo-item-body">
        <div class="field-row">
          <div class="field"><label>Titolo voce</label><input type="text" id="dec-t-${idx}" value="${esc(item.t||'')}" oninput="document.getElementById('dec-label-${idx}').textContent=this.value"></div>
          <div class="field"><label>Icona Lucide</label><input type="text" id="dec-i-${idx}" value="${esc(item.i||'')}" placeholder="es. home, heart, users, clock..."></div>
        </div>
        <div class="field">
          <label>Descrizione â€” supporta <b>grassetto</b>, <i>corsivo</i>, colori</label>
          ${richEditorHTML(`dec-d-${idx}`, item.d||'')}
        </div>
      </div>`;
    container.appendChild(div);
  });
}

function toggleDec(idx) { document.getElementById(`dec-${idx}`).classList.toggle('open'); }

function collectDecalogo() {
  return (DATA.decalogo?.items || []).map((item, idx) => ({
    n: item.n || String(idx+1).padStart(2,'0'),
    t: document.getElementById(`dec-t-${idx}`)?.value?.trim() || item.t,
    d: getRich(`dec-d-${idx}`),
    i: document.getElementById(`dec-i-${idx}`)?.value?.trim() || item.i
  }));
}

// â”€â”€â”€ ARCHIVIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderArchiveList() {
  const list = document.getElementById('archive-list');
  list.innerHTML = '';
  const items = [...(DATA.archive||[])].sort((a,b) => new Date(b.date) - new Date(a.date));
  items.forEach(item => {
    const el = document.createElement('div');
    el.className = 'archive-item';
    el.id = `ai-${item.id}`;
    el.innerHTML = `
      <div class="archive-item-header" onclick="toggleAI(${item.id})">
        <div class="archive-item-title">
          <span id="ai-label-${item.id}">${esc(item.t)||'Nuovo evento'}</span>
          <span class="tag-badge tag-${item.tag||'famiglie'}">${item.tag||'famiglie'}</span>
          <span style="font-size:.75rem;color:var(--text-light);font-weight:400;white-space:nowrap">${esc(item.d)}</span>
        </div>
        <div class="archive-item-actions">
          <button class="btn-sm btn-danger"  onclick="event.stopPropagation();removeAI(${item.id})">ğŸ—‘ Elimina</button>
          <button class="btn-sm btn-primary" onclick="event.stopPropagation();toggleAI(${item.id})">âœï¸ Modifica</button>
        </div>
      </div>
      <div class="archive-item-body">

        <!-- INFORMAZIONI -->
        <div class="section-block">
          <div class="section-label">ğŸ“‹ Informazioni evento</div>
          <div class="field-row">
            <div class="field"><label>Nome evento *</label>
              <input type="text" id="ai-t-${item.id}" value="${esc(item.t)}"
                oninput="document.getElementById('ai-label-${item.id}').textContent=this.value||'Nuovo evento'">
            </div>
            <div class="field"><label>Data leggibile (es. Marzo 2026)</label><input type="text" id="ai-d-${item.id}" value="${esc(item.d)}"></div>
          </div>
          <div class="field-row3">
            <div class="field"><label>Data per ordinamento</label><input type="date" id="ai-date-${item.id}" value="${esc(item.date)}"></div>
            <div class="field"><label>Categoria</label>
              <select id="ai-tag-${item.id}">
                <option value="famiglie"   ${item.tag==='famiglie'?'selected':''}>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Famiglie</option>
                <option value="tradizioni" ${item.tag==='tradizioni'?'selected':''}>ğŸ”¥ Tradizioni</option>
                <option value="spettacoli" ${item.tag==='spettacoli'?'selected':''}>ğŸ­ Spettacoli</option>
              </select>
            </div>
            <div class="field"><label>Nota breve (es. Sold Out)</label><input type="text" id="ai-n-${item.id}" value="${esc(item.n)}"></div>
          </div>
        </div>

        <!-- COPERTINA -->
        <div class="section-block">
          <div class="section-label">ğŸ–¼ï¸ Immagine copertina (card)</div>
          <div class="dim-hint"><span class="ratio-icon">ğŸ“</span>
            Ideale: <strong>800 Ã— 600 px</strong> orizzontale 4:3 â€” oppure <strong>800 Ã— 800 px</strong> quadrata â€” evita il ritaglio automatico
          </div>
          <div class="field"><label>Nome file copertina (caricato su GitHub)</label>
            <input type="text" id="ai-img-${item.id}" value="${esc(item.img)}" placeholder="es. falo.png">
          </div>
        </div>

        <!-- GALLERIA -->
        <div class="section-block">
          <div class="section-label">ğŸ“¸ Galleria foto (nella scheda evento)</div>
          <div class="field">
            <label>Nomi file separati da virgola</label>
            <input type="text" id="ai-gallery-${item.id}" value="${esc((item.gallery||[]).join(', '))}" placeholder="foto1.png, foto2.png, foto3.png">
          </div>
          <p style="font-size:.7rem;color:var(--honey-dark);font-weight:600;margin-top:.35rem;">
            âœ¨ Vai in <strong>Carica Foto</strong>, seleziona questo evento e carica â€” la galleria si aggiorna automaticamente.
          </p>
        </div>

        <!-- TESTI -->
        <div class="section-block">
          <div class="section-label">ğŸ“ Testi</div>
          <div class="field"><label>Descrizione breve (nella card)</label>
            <input type="text" id="ai-desc-${item.id}" value="${esc(item.desc)}">
          </div>
          <div class="field">
            <label>Descrizione completa (nella scheda modale) â€” supporta <b>grassetto</b>, <i>corsivo</i>, colori</label>
            ${richEditorHTML(`ai-fulldesc-${item.id}`, item.fullDesc||item.desc)}
          </div>
        </div>

      </div>`;
    list.appendChild(el);
  });
}

function toggleAI(id) { document.getElementById(`ai-${id}`).classList.toggle('editing'); }

function addArchiveItem() {
  const maxId = Math.max(0,...(DATA.archive||[]).map(i=>i.id));
  const newId = maxId + 1;
  DATA.archive = DATA.archive || [];
  DATA.archive.push({ id:newId, date:new Date().toISOString().split('T')[0], tag:'famiglie', t:'Nuovo Evento', d:'', n:'', desc:'', fullDesc:'', img:'', gallery:[] });
  renderArchiveList();
  setTimeout(() => {
    const el = document.getElementById(`ai-${newId}`);
    if (el) { el.classList.add('editing'); el.scrollIntoView({behavior:'smooth',block:'center'}); }
  }, 50);
}

function removeAI(id) {
  if (!confirm('Eliminare questo evento dall\'archivio?')) return;
  DATA.archive = DATA.archive.filter(i => i.id !== id);
  renderArchiveList();
}

function collectArchive() {
  const g = (id, fb='') => document.getElementById(id)?.value?.trim() || fb;
  DATA.archive = (DATA.archive||[]).map(item => {
    const id = item.id;
    return {
      id,
      date:     g(`ai-date-${id}`, item.date),
      tag:      g(`ai-tag-${id}`,  item.tag),
      t:        g(`ai-t-${id}`,    item.t),
      d:        g(`ai-d-${id}`,    item.d),
      n:        g(`ai-n-${id}`,    item.n),
      desc:     g(`ai-desc-${id}`, item.desc),
      fullDesc: getRich(`ai-fulldesc-${id}`) || g(`ai-desc-${id}`, item.desc),
      img:      g(`ai-img-${id}`,  item.img),
      gallery:  g(`ai-gallery-${id}`,'').split(',').map(s=>s.trim()).filter(Boolean)
    };
  });
}

// â”€â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function showSection(name) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById(`panel-${name}`).classList.add('active');
  document.getElementById(`nav-${name}`).classList.add('active');
}

// â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let toastTimer;
function showToast(msg, type='success') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = `show ${type}`;
  clearTimeout(toastTimer);
  if (type !== 'loading') toastTimer = setTimeout(() => { t.className = ''; }, 4500);
}

// â”€â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function esc(s) {
  return (s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€â”€ UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function populateUploadSelector() {
  const sel = document.getElementById('upload-event-selector');
  if (!sel) return;
  // Rimuovi le opzioni archivio precedenti (tieni le prime 2: vuota + featured)
  while (sel.options.length > 2) sel.remove(2);
  const sorted = [...(DATA.archive||[])].sort((a,b) => new Date(b.date) - new Date(a.date));
  sorted.forEach(ev => {
    const opt = document.createElement('option');
    opt.value = String(ev.id);
    opt.textContent = `${ev.d ? ev.d + ' â€” ' : ''}${ev.t}`;
    sel.appendChild(opt);
  });
  sel.addEventListener('change', updateDestinationPreview);
  document.getElementById('upload-image-type')?.addEventListener('change', updateDestinationPreview);
}

function updateDestinationPreview() {
  const sel   = document.getElementById('upload-event-selector');
  const type  = document.getElementById('upload-image-type');
  const prev  = document.getElementById('upload-destination-preview');
  if (!sel || !prev) return;
  const eventVal = sel.value;
  const typeVal  = type?.value || 'gallery';
  if (!eventVal) { prev.style.display = 'none'; return; }
  let label = '';
  if (eventVal === 'featured') {
    label = `â­ Prossimo Evento â†’ Immagine copertina`;
  } else {
    const ev = DATA.archive?.find(e => String(e.id) === eventVal);
    const typeLabel = typeVal === 'cover' ? 'Immagine copertina' : 'Galleria foto';
    label = `ğŸ“ ${ev?.t || '?'} â†’ ${typeLabel}`;
  }
  prev.textContent = `Le prossime foto andranno a: ${label}`;
  prev.style.display = 'block';
}

function attachUploadedFileToEvent(filename) {
  const sel      = document.getElementById('upload-event-selector');
  const typeEl   = document.getElementById('upload-image-type');
  const eventVal = sel?.value;
  const imageType = typeEl?.value || 'gallery';
  if (!eventVal) return;

  if (eventVal === 'featured') {
    DATA.featuredEvent = DATA.featuredEvent || {};
    DATA.featuredEvent.img = filename;
    set('ev-img', filename);
    return;
  }

  const eventId = parseInt(eventVal);
  const ev = DATA.archive?.find(e => e.id === eventId);
  if (!ev) return;

  if (imageType === 'cover') {
    ev.img = filename;
    const inp = document.getElementById(`ai-img-${eventId}`);
    if (inp) inp.value = filename;
  } else {
    if (!ev.gallery) ev.gallery = [];
    if (!ev.gallery.includes(filename)) ev.gallery.push(filename);
    const inp = document.getElementById(`ai-gallery-${eventId}`);
    if (inp) {
      const cur = inp.value.trim();
      inp.value = cur ? `${cur}, ${filename}` : filename;
    }
  }
}

function handleDragOver(e)  { e.preventDefault(); document.getElementById('upload-zone').classList.add('drag-over'); }
function handleDragLeave(e) { document.getElementById('upload-zone').classList.remove('drag-over'); }
function handleDrop(e) {
  e.preventDefault();
  document.getElementById('upload-zone').classList.remove('drag-over');
  uploadFiles(Array.from(e.dataTransfer.files));
}
function handleFileSelect(e) { uploadFiles(Array.from(e.target.files)); }

async function uploadFiles(files) {
  const imageFiles = files.filter(f => f.type.startsWith('image/'));
  if (!imageFiles.length) { showToast('âš ï¸ Seleziona solo file immagine', 'error'); return; }
  const tooBig = imageFiles.filter(f => f.size > 5*1024*1024);
  if (tooBig.length) { showToast(`âš ï¸ File troppo grandi (max 5MB): ${tooBig.map(f=>f.name).join(', ')}`, 'error'); return; }
  const prog = document.getElementById('upload-progress');
  const fill = document.getElementById('upload-progress-fill');
  const statusText = document.getElementById('upload-status-text');
  prog.style.display = 'block';
  for (let i = 0; i < imageFiles.length; i++) {
    const file = imageFiles[i];
    statusText.textContent = `Caricamento ${i+1}/${imageFiles.length}: ${file.name}`;
    fill.style.width = `${Math.round((i/imageFiles.length)*100)}%`;
    try {
      const base64 = await fileToBase64(file);
      const b64content = base64.split(',')[1];
      let sha = undefined;
      try {
        const check = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${file.name}`,
          { headers: { Authorization:`token ${TOKEN}`, Accept:'application/vnd.github.v3+json' } });
        if (check.ok) { const ex = await check.json(); sha = ex.sha; }
      } catch(e) {}
      const body = { message:`ğŸ–¼ï¸ Upload: ${file.name}`, content:b64content };
      if (sha) body.sha = sha;
      const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${file.name}`, {
        method:'PUT',
        headers:{ Authorization:`token ${TOKEN}`, Accept:'application/vnd.github.v3+json', 'Content-Type':'application/json' },
        body:JSON.stringify(body)
      });
      if (res.ok) {
        attachUploadedFileToEvent(file.name);
        const eventVal = document.getElementById('upload-event-selector')?.value;
        addUploadedChip(file.name, !!eventVal);
        showToast(`âœ… ${file.name} caricato${eventVal ? ' e collegato all\'evento!' : '!'}`, 'success');
      } else { const err = await res.json(); showToast(`âŒ ${file.name}: ${err.message}`, 'error'); }
    } catch(e) { showToast(`âŒ Errore: ${e.message}`, 'error'); }
  }
  fill.style.width = '100%';
  statusText.textContent = 'âœ… Completato!';
  setTimeout(() => { prog.style.display='none'; fill.style.width='0%'; }, 2000);
  document.getElementById('file-input').value = '';
}

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload  = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function addUploadedChip(filename, autoLinked) {
  const list = document.getElementById('uploaded-files-list');
  const chip = document.createElement('div');
  chip.className = 'uploaded-chip';
  const icon = autoLinked ? 'ğŸ”—' : 'ğŸ“‹';
  const suffix = autoLinked ? ' (collegato)' : '';
  chip.title = autoLinked ? 'Collegato automaticamente all\'evento â€” clicca per copiare il nome' : 'Clicca per copiare il nome file';
  chip.innerHTML = `<span>${icon}</span> ${esc(filename)}<span style="font-weight:400;font-size:.65rem;opacity:.7">${suffix}</span>`;
  chip.onclick = () => {
    navigator.clipboard.writeText(filename).then(() => {
      chip.innerHTML = `<span>âœ…</span> ${esc(filename)}`;
      setTimeout(() => { chip.innerHTML = `<span>${icon}</span> ${esc(filename)}<span style="font-weight:400;font-size:.65rem;opacity:.7">${suffix}</span>`; }, 1500);
    });
  };
  list.appendChild(chip);
}

// â”€â”€â”€ AUTO-LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

window.addEventListener('DOMContentLoaded', () => {
  initStaticRichEditors();
  const o = localStorage.getItem('crea_owner');
  const r = localStorage.getItem('crea_repo');
  const t = localStorage.getItem('crea_token');
  if (o && r && t) {
    OWNER=o; REPO=r; TOKEN=t;
    document.getElementById('inp-owner').value = o;
    document.getElementById('inp-repo').value  = r;
    document.getElementById('inp-token').value = t;
    showToast('Caricamento...','loading');
    loadData()
      .then(ok => { if (ok) startApp(); else { OWNER=REPO=TOKEN=''; showToast('âŒ Token scaduto, accedi di nuovo.','error'); } })
      .catch(() => { OWNER=REPO=TOKEN=''; });
  }
});
</script>
</body>
</html>
